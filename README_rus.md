# SVGA_IMITATOR

## Цель

Целью проекта является моделирование вывода на экран монитора при отладке RTL проекта.

Результаты:

* Программа SVGA_IMITATOR
* Разделяемая библиотка  svga_dpi.so
* Компонент sim_svga
* Примеры использования sim_svga в проектах из репозитория basics-graphics-music

## Общее описание

Для моделирования отображения изображения на экране монитора используется технология подключения внешней DLL к RTL симулятору через интерфейс DPI. Далее DLL использует разделяемую память для формирования видеобуфера. Программа имитатора получает данные из разделяемой памяти и формирует изображение.

Требуется отдельно запустить программу имитатора и сеанс моделирования. Сеанс моделирования может быть многократно перезапущен. 
Программа определяет факт запуска или перезапуска RTL симулятора и настраивается на текущее параметры разрешения экрана.

Программа имитатора сделана на основе Cooperspice: https://www.copperspice.com/

Для моделирования используется симулятор Vivado. Возможно использование других симуляторов однако для них нужно собирать другие разделяемые библиотеки.

Программа имитатора также формирует файлы изображений для каждого полученного кадра. Названия файлов: svga_nn.png, где nn - номер кадра

Примеры изображений:
* 2_1_rectangle_ellipse_parabola [2_1_rectangle_ellipse_parabola.md](./doc/2_1_rectangle_ellipse_parabola.md)
* svga_osc [svga_osc.md](./doc/svga_osc.md)

## Используемые проекты

Проект создан на основе следующих проектов:

* https://github.com/yuri-panchul/basics-graphics-music
* https://github.com/dsmv/2023-lalambda-fpga-labs
* https://github.com/dsmv/vivado_simulation_example

## Структура каталогов

Структура каталогов повторяет структуру проекта basics-graphics-music
* basics-graphics-music - проекты RTL
    * boards - каталоги с проектами для целевых плат
        * rzrd_svga - модуль RZRD с поддержкой режима SVGA 1024x768
    * labs   - каталоги лабораторных
        * 2_graphics - базовые проекты для работы с графикой
            * 2_1_rectangle_ellipse_parabola - вывод нескольких фигур
        * 99_svga - проекты для режима SVGA 1024x768
            * svga_osc - портирование проекта lab_ext_svga_osc из 2023-lalambda-fpga-labs
        * common - общие файлы для синтеза
        * tb_common - общие файлы для моделирования
    * peripherals - общие компоненты
    * scripts - командные файлы
* src - код программы SVGA_IMITATOR
* svga_dpi_dll - код разделяемой библиотеки svga_dpi.so
    * vivado - исходный код и скрипты сборки для системы Vivado

## Сборка svga_dpi.so для системы Vivado

Файл svga_dpi_dll/vivado/tb.sv содержит описания функций которые должны быть реализованы во внещней DLL.

Порядок сборки:

* Запустить ./create_header.sh - будет сформирован заголовочный файл svga_dpi.h
* Проверить описания функций, при необходимости скорректировать svga_dpi.cpp
* Запустить ./compile_dpi.sh - будет сформирован svga_dpi.so

Файл svga_dpi.so должен подключаться на этапе elaborate с использованием ключа -sv_lib:

    xelab  -sv_lib ../../../../../../svga_dpi_dll/vivado/svga_dpi.so --incr -O0 --relax --mt 8 -L xil_defaultlib  --snapshot tb_behav tb -debug all     

Для сборки требуется установленная библиотека boost

## Сборка SVGA_IMITATOR

Требуется установить фреймворк Cooperspcie. Сборка проводиться с использованием cmake.

## Моделирование

Моделирование выполняется в системе Vivado. Тестовый пример разработан на основе проекта vivado_simulation_example.

Требуется провести подготовку Vivado как указано в документе: https://github.com/dsmv/vivado_simulation_example/blob/main/README_rus.md

Моделирование производится в каталоге run_sim_vivado/sim_xx выбранного проекта. Для примера svga_osc и теста tb_01 рабочим каталогом будет: labs/99_svga/svga_osc/run_sim_vivado/sim_01

Файл run_sim_vivado/env.sh используется для настройки путей. При первом запуске терминала требуется выполнить:

    source ../env.sh

Файл проверяет наличие файла env_user.sh, если такой файл есть, то будет вызван он. Если путь или версия Vivado отличается то надо сформировать файл env_user.sh из файла env_user.sh.in и прописать там правильный путь к файлу settings64.sh

Для успешного выполнения elaborate.sh требуется скомпилированная библиотека svga_dpi.so

Командные файлы:

* compile.sh - компиляция исходных текстов. Файл systemverilog.sh содержит список файлов для компиляции
* elaborate.sh - сборка проекта
* c_run_0.sh - запуск моделирования в режиме командной строки
* g_run.sh - запуск Vivado в режиме GUI
* g_run.tcl - команда на перезапуск сеанса моделирования.

В файле g_run.tcl указаны файлы .wcfg с описанием сигналов для временных диаграмм.

## Алгоритм работы в системе Visual Studio Code

* Открыть каталог labs/99_svga/svga_osc/run_sim_vivado/sim_01 во строенном терминале Visual Studio Code
* Провести настройку на систему моделирования: source ../env.sh  
* Провести компиляцию: ./compile.sh
* Провести сборку: ./elaborate.sh
* Запустить Vivado в режиме GUI:
    * Открыть каталог labs/99_svga/svga_osc/run_sim_vivado/sim_01 (Open Container Folder)
    * Открыть терминал
    * Запустить: ./g_run.sh
* Запустить сеанс моделирования на 280 us

Для перезапуска сеанса моделирования:
* Действия во встроенном терминале Visual Studio Code (предполагается что он открыт и там выполнени source ../env.sh)
    * Провести компиляцию: ./compile.sh
    * Провести сборку: ./elaborate.sh
* Действия в Vivado GUI:
    * Выполнить команду relaunch_sim через иконку в строке Toolbox. Предполагается что выполнена подготовка в соотвествии с указаниями в проекте vivado_simulation_example
    * Запустить сеанс моделирования на 280 us    

Перед выполнением relaunch_sim требуется сохранить все изменения в окнах временных диаграмм.

В файл g_run.tcl можно добавить указания на открытие новых окон временных диаграмм. Для добавления импользуется параметр -view <имя>.wcfg

